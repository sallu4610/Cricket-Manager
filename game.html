<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cricket Word City - Powered Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- General Styles --- */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow-x: hidden;
      user-select: none;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 32px;
      text-align: center;
      margin: 10px 0 15px;
      text-shadow: 0 0 12px #ffcc00;
    }

    /* --- Level Selection Screen --- */
    #level-select {
      display: none;
      width: 100%;
      max-width: 480px;
      padding: 10px;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-bottom: 15px;
      user-select: none;
    }
    .level-card {
      position: relative;
      width: 110px;
      height: 75px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px #ffcc00cc;
      cursor: pointer;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffcc00;
      font-weight: 700;
      font-size: 20px;
      text-shadow: 0 0 4px #ffcc00bb;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .level-card:hover:not(.locked) {
      transform: scale(1.08);
      box-shadow: 0 0 25px #ffaa00dd;
    }
    .level-card.locked {
      filter: blur(2px) grayscale(80%);
      cursor: default;
    }
    .level-card.locked::after {
      content: "üîí";
      position: absolute;
      top: 5px; right: 5px;
      font-size: 26px;
      user-select: none;
    }
    .level-card img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      filter: brightness(0.5);
      border-radius: 12px;
    }
    .level-number {
      position: relative;
      z-index: 2;
    }

    /* --- Game Container --- */
    #game {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
      padding: 20px;
      background-size: cover;
      background-position: center;
      min-height: 600px;
      position: relative;
      box-shadow: inset 0 0 80px #000a;
      border-radius: 14px;
      margin-bottom: 30px;
    }

    /* --- Pillboxes --- */
    #pillboxes {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 14px;
      perspective: 500px;
    }
    .pill {
      padding: 12px 20px;
      border-radius: 50px;
      background: linear-gradient(135deg, #ffcc00, #ffaa00);
      color: #000;
      font-size: 18px;
      font-weight: 900;
      min-width: 90px;
      text-align: center;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    .pill.completed {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: #d4f2c5;
      box-shadow: 0 0 20px #28a745dd;
      transform: scale(1.1);
    }

    /* --- Selected Word Display --- */
    #selected-word {
      font-size: 28px;
      margin: 12px 0 8px;
      letter-spacing: 6px;
      font-weight: 700;
      color: #ffcc00;
      text-shadow: 0 0 16px #ffcc00dd;
      min-height: 32px;
      user-select: none;
      text-align: center;
      animation: pulse 1.5s infinite alternate;
    }
    @keyframes pulse {
        from { text-shadow: 0 0 10px #ffcc00bb; }
        to { text-shadow: 0 0 25px #ffcc00ff; }
    }

    /* --- Letter Circle --- */
    #letter-circle {
      position: relative;
      width: 320px;
      height: 320px;
      margin: 0 auto 20px;
      border-radius: 50%;
      user-select: none;
      touch-action: none;
    }
    .letter {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #222;
      color: #fff;
      font-size: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s;
      z-index: 2;
      box-shadow: 0 0 8px #555;
      font-weight: 700;
    }
    .letter.active {
      background: #28a745;
      box-shadow: 0 0 20px #28a745dd, 0 0 40px #a6f199aa;
      transform: scale(1.05);
    }

    /* --- Shuffle Button --- */
    #shuffle-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      background: linear-gradient(45deg, #ffcc00, #ffaa00);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
      z-index: 3;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    #shuffle-button:hover {
      transform: translate(-50%, -50%) scale(1.1);
      box-shadow: 0 0 25px rgba(255, 204, 0, 1);
    }

    /* --- Drag line canvas --- */
    #drag-line-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }

    /* --- Hint and Result Boxes --- */
    #hint, #result {
      margin-top: 12px;
      padding: 10px 20px;
      background: rgba(0,0,0,0.75);
      border-radius: 8px;
      max-width: 90%;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      user-select: text;
      min-height: 32px;
      box-shadow: inset 0 0 8px #ffcc00aa;
    }

    /* --- Buttons --- */
    button, #back-button-level-select, #back-button-game {
      padding: 12px 28px;
      font-size: 18px;
      background: linear-gradient(135deg, #ffcc00, #ffaa00);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 18px 10px 0 10px;
      font-weight: 900;
      box-shadow: 0 0 14px #ffcc00aa;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled),
    #back-button-level-select:hover,
    #back-button-game:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px #ffcc00dd;
    }
    button:disabled {
      background: #666;
      cursor: default;
      box-shadow: none;
      color: #bbb;
      filter: grayscale(70%);
    }
    #btn-clear {
        background: linear-gradient(135deg, #dc3545, #bd2130);
        box-shadow: 0 0 14px #dc3545aa;
    }
    #btn-clear:hover:not(:disabled) {
        box-shadow: 0 0 30px #dc3545dd;
    }

    /* --- Modal --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background-color: #111;
      margin: 10% auto;
      padding: 20px 30px;
      border: 3px solid #ffcc00;
      width: 85%;
      max-width: 420px;
      text-align: center;
      color: white;
      border-radius: 14px;
      box-shadow: 0 0 40px #ffcc00ee;
      position: relative;
    }
    .modal-content img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 20px #ffcc00bb;
      margin-bottom: 15px;
    }
    .close {
      color: #ffcc00;
      position: absolute;
      top: 12px;
      right: 18px;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
    }
    .close:hover {
      color: #ffaa00;
    }

    /* --- Fireworks Container --- */
    #fireworks-container {
      pointer-events: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 10000;
      overflow: visible;
    }

    /* --- New reward message container --- */
    #reward-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 20px 30px;
      border-radius: 15px;
      border: 3px solid #ffcc00;
      box-shadow: 0 0 25px #ffcc00;
      text-align: center;
      z-index: 10001;
      font-size: 22px;
      font-weight: bold;
      animation: fadeInOut 3s forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
    }
  </style>
</head>
<body>

  <div id="level-select" aria-label="Level selection screen" role="list">
    <button id="back-button-level-select" onclick="window.location.href='index.html'">Back to Main Page</button>
  </div>

  <div id="game" role="main" aria-live="polite" aria-atomic="true" aria-label="Game screen">
    <h1>üèè Cricket Word City</h1>
    <div id="pillboxes" aria-label="Found words"></div>
    <div id="selected-word" aria-live="polite" aria-atomic="true"></div>

    <div id="letter-circle" aria-label="Letter selection circle" role="list">
        <canvas id="drag-line-canvas"></canvas>
        <div id="shuffle-button" aria-label="Shuffle letters">üîÄ</div>
    </div>

    <div id="hint" aria-live="polite" aria-atomic="true"></div>

    <button id="btn-hint" aria-label="Show hint">Hint ‚ú®</button>
    <button id="btn-clear" aria-label="Clear selected word">Clear üóëÔ∏è</button>
    <button id="btn-next" disabled aria-label="Next level">Next Level ‚ñ∂Ô∏è</button>
    <div id="result" aria-live="polite" aria-atomic="true"></div>
    
    <button id="back-button-game" onclick="window.location.href='index.html'">Back to Main Page</button>

    <div id="reward-message" aria-live="polite" aria-atomic="true"></div>

    <div id="rewardModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <div class="modal-content">
        <span class="close" onclick="closeRewardModal()" aria-label="Close modal">&times;</span>
        <img id="preview-image" src="" alt="Level background" />
        <p id="preview-text"></p>
      </div>
    </div>

  </div>

  <canvas id="fireworks-container"></canvas>

  <script>
    const imageUrls = [
      "https://i.postimg.cc/BLVMxPHM/image.jpg",
      "https://i.postimg.cc/HJ3SkhxG/image.jpg",
      "https://i.postimg.cc/qhR1hxhN/image.jpg",
      "https://i.postimg.cc/JHHKK7Qm/image.jpg",
      "https://i.postimg.cc/WdvS6vqL/image.jpg",
      "https://i.postimg.cc/8s7yTwg3/image.jpg",
      "https://i.postimg.cc/PN0SJZtq/image.jpg",
      "https://i.postimg.cc/JGJPknn5/image.jpg",
      "https://i.postimg.cc/TKJ0t4ny/image.jpg",
      "https://i.postimg.cc/Ty29FJct/image.jpg"
    ];

    const levelDescriptions = [
      "üìÖ Jan 18, 2015: AB de Villiers smashed the fastest ODI century in just 31 balls against the West Indies.",
      "üìÖ Mar 21, 2022: Babar Azam scored a magnificent 196 runs against Australia in the Karachi Test.",
      "üìÖ Aug 22, 2019: Ben Stokes played a match-winning innings of 135 against Australia in the Ashes.",
      "üìÖ Mar 14, 1996: Michael Bevan hit a last-ball boundary to win vs West Indies in the World Cup.",
      "üìÖ Mar 3, 2016: Carlos Brathwaite hit 4 sixes in a row to win the 2016 T20 World Cup Final.",
      "üìÖ Jun 14, 2017: Bumrah bowled a lethal yorker to Maxwell in the Champions Trophy Final.",
      "üìÖ Apr 2, 2011: MS Dhoni's iconic six sealed the 2011 World Cup win for India.",
      "üìÖ Nov 2021: Rizwan went from ICU to semi-final hero in T20 WC 2021.",
      "üìÖ Mar 25, 1992: Imran Khan led Pakistan to their first World Cup victory.",
      "üìÖ Mar 2019: Kusal Perera scored an unforgettable 153* vs South Africa."
    ];

    const levels = [
      { words: ["SIX", "SPIN", "PACE"], hint: "Big boundary hit over fence, Ball turns on the pitch, Fast bowling speed" },
      { words: ["SLIP", "SEAM", "BAIL"], hint: "Fielder next to the wicketkeeper, Raised stitch on the ball, Small piece on top of stumps" },
      { words: ["BEAM", "JUMP", "OUT"], hint: "Bright light or laser (used for DRS), Quick move by a fielder, When a batsman is dismissed" },
      { words: ["DROP", "BAT", "YARD"], hint: "Fielder misses the catch, Equipment to hit the ball, Measurement of the cricket ground" },
      { words: ["FLY", "JERK", "ASH"], hint: "Ball hit high in the air, Sudden movement or twist, Historic Test cricket series" },
      { words: ["RUN", "HIT", "LEG"], hint: "Single point scored, Strike the ball with bat, Part of the body, also a fielding area" },
      { words: ["GAP", "PAD", "TIP"], hint: "Space between fielders, Protective gear for legs, Edge of the bat" },
      { words: ["WIDE", "DOT", "RUNS"], hint: "Ball outside batsman's reach, Ball with no runs scored, Total points scored" },
      { words: ["BALL", "FIELD", "CATCH"], hint: "Spherical object bowled, Area where game is played, Grabbing the ball in the air" },
      { words: ["BOWL", "PLAY", "TEAM"], hint: "Deliver the ball to batsman, Participate in the game, Group of players" }
    ];

    let currentLevel = 0;
    let selected = "";
    let foundWords = new Set();
    let hintsUsed = 0;

    let isDragging = false;
    let selectedLetterElements = [];
    let dragCanvas;
    let dragCtx;

    const levelSelect = document.getElementById("level-select");
    const gameContainer = document.getElementById("game");
    const pillboxes = document.getElementById("pillboxes");
    const selectedWordDisplay = document.getElementById("selected-word");
    const circle = document.getElementById("letter-circle");
    const hintBox = document.getElementById("hint");
    const resultBox = document.getElementById("result");
    const btnHint = document.getElementById("btn-hint");
    const btnClear = document.getElementById("btn-clear");
    const btnNext = document.getElementById("btn-next");
    const rewardMessage = document.getElementById("reward-message");
    let btnShuffle;
    const rewardModal = document.getElementById("rewardModal");
    const previewImage = document.getElementById("preview-image");
    const previewText = document.getElementById("preview-text");

    const soundSelect = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
    const soundComplete = new Audio("https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg");
    const soundError = new Audio("https://actions.google.com/sounds/v1/foley/whoosh_foley.ogg");
    const soundShuffle = new Audio("https://actions.google.com/sounds/v1/ui/swipe_to_select.ogg");

    const fwCanvas = document.getElementById("fireworks-container");
    const fwCtx = fwCanvas.getContext("2d");
    fwCanvas.width = window.innerWidth;
    fwCanvas.height = window.innerHeight;
    window.addEventListener("resize", () => {
      fwCanvas.width = window.innerWidth;
      fwCanvas.height = window.innerHeight;
    });

    class Firework {
      constructor() {
        this.x = Math.random() * fwCanvas.width;
        this.y = fwCanvas.height;
        this.targetY = Math.random() * fwCanvas.height / 2;
        this.speed = 5 + Math.random() * 3;
        this.particles = [];
        this.exploded = false;
        this.hue = Math.random() * 360;
      }
      update() {
        if (!this.exploded) {
          this.y -= this.speed;
          fwCtx.beginPath();
          fwCtx.arc(this.x, this.y + 15, 2, 0, Math.PI * 2);
          fwCtx.fillStyle = `hsl(${this.hue}, 100%, 70%, 0.5)`;
          fwCtx.fill();
          if (this.y <= this.targetY) {
            this.explode();
          }
        }
        this.particles.forEach(p => p.update());
        this.particles = this.particles.filter(p => !p.done);
      }
      explode() {
        this.exploded = true;
        const count = 30 + Math.floor(Math.random() * 20);
        for(let i=0; i<count; i++){
          this.particles.push(new Particle(this.x, this.y, this.hue));
        }
      }
      draw() {
        this.particles.forEach(p => p.draw());
      }
      isDone() {
        return this.exploded && this.particles.length === 0;
      }
    }

    class Particle {
      constructor(x, y, hue) {
        this.x = x;
        this.y = y;
        this.speedX = (Math.random() - 0.5) * 8;
        this.speedY = (Math.random() - 0.5) * 8;
        this.alpha = 1;
        this.size = 3 + Math.random() * 2;
        this.gravity = 0.05;
        this.done = false;
        this.color = `hsl(${hue + (Math.random() * 60 - 30)}, 100%, 60%)`;
      }
      update() {
        this.speedY += this.gravity;
        this.x += this.speedX;
        this.y += this.speedY;
        this.alpha -= 0.02;
        if (this.alpha <= 0) {
          this.done = true;
        }
      }
      draw() {
        fwCtx.save();
        fwCtx.globalAlpha = this.alpha;
        fwCtx.fillStyle = this.color;
        fwCtx.beginPath();
        fwCtx.arc(this.x, this.y, this.size, 0, Math.PI*2);
        fwCtx.fill();
        fwCtx.restore();
      }
    }

    let fireworks = [];
    function launchFireworks(){
      fireworks.push(new Firework());
    }

    function animateFireworks(){
      fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
      fireworks.forEach(fw => {
        fw.update();
        fw.draw();
      });
      fireworks = fireworks.filter(fw => !fw.isDone());
      if (fireworks.length > 0) {
        requestAnimationFrame(animateFireworks);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
        initializeGame();
    });

    function getSavedProgress() {
      let highestLevel = 0;
      for (let i = 0; i < levels.length; i++) {
        if (localStorage.getItem("cricketWordCity_level_" + i) === "completed") {
          highestLevel = i + 1;
        }
      }
      return highestLevel;
    }

    function showLevelSelect(){
      levelSelect.innerHTML = "";
      gameContainer.style.display = "none";
      levelSelect.style.display = "flex";

      const maxUnlockedLevel = getSavedProgress();

      for(let i=0; i<levels.length; i++){
        const lvl = document.createElement("div");
        lvl.classList.add("level-card");
        lvl.setAttribute("role","listitem");
        lvl.setAttribute("tabindex","0");

        const img = document.createElement("img");
        img.src = imageUrls[i];
        img.alt = `Background image for level ${i+1}`;
        lvl.appendChild(img);

        const num = document.createElement("div");
        num.classList.add("level-number");
        num.textContent = i+1;
        lvl.appendChild(num);

        const unlocked = i <= maxUnlockedLevel;
        if (!unlocked) {
          lvl.classList.add("locked");
          lvl.setAttribute("aria-disabled","true");
          lvl.removeAttribute("tabindex");
        } else {
          lvl.addEventListener("click", () => {
            currentLevel = i;
            startLevel(i);
          });
          lvl.addEventListener("keypress", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              currentLevel = i;
              startLevel(i);
            }
          });
        }
        levelSelect.appendChild(lvl);
      }
      const backBtn = document.createElement("button");
      backBtn.id = "back-button-level-select";
      backBtn.textContent = "Back to Main Page";
      backBtn.onclick = () => window.location.href = 'index.html';
      levelSelect.appendChild(backBtn);
    }

    function startLevel(levelIndex){
      levelSelect.style.display = "none";
      gameContainer.style.display = "flex";
      resetGame();

      currentLevel = levelIndex;
      foundWords.clear();
      hintsUsed = 0;
      hintBox.textContent = "";
      resultBox.textContent = "";
      btnNext.disabled = true;

      gameContainer.style.backgroundImage = `url('${imageUrls[levelIndex]}')`;

      setupLevel(levels[levelIndex].words);

      hints = levels[currentLevel].hint.split(",").map(h => h.trim());
      hints = hints.slice(0,3);

      pillboxes.innerHTML = "";
      levels[levelIndex].words.forEach(word => {
        const pill = document.createElement("div");
        pill.classList.add("pill");
        pill.textContent = "_".repeat(word.length);
        pillboxes.appendChild(pill);
      });

      selected = "";
      updateSelectedWord();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    let allLetters = [];
    function setupLevel(words) {
      let lettersSet = new Set();
      words.forEach(w => {
        w.split("").forEach(l => lettersSet.add(l));
      });
      allLetters = Array.from(lettersSet);

      while(allLetters.length < 5) {
        const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const randomLetter = alpha.charAt(Math.floor(Math.random()*alpha.length));
        if(!lettersSet.has(randomLetter)) {
          lettersSet.add(randomLetter);
          allLetters.push(randomLetter);
        }
      }
      shuffleLetters(false);
    }

    function shuffleLetters(playSound = true) {
        clearActiveLetters(false);
        if (playSound) {
            soundShuffle.play().catch(() => {});
        }

        shuffleArray(allLetters);

        circle.innerHTML = "";
        const dragLineCanvas = document.createElement("canvas");
        dragLineCanvas.id = "drag-line-canvas";
        circle.appendChild(dragLineCanvas);

        const shuffleButton = document.createElement("div");
        shuffleButton.id = "shuffle-button";
        shuffleButton.innerHTML = "üîÄ";
        circle.appendChild(shuffleButton);

        btnShuffle = document.getElementById("shuffle-button");
        btnShuffle.addEventListener("click", () => shuffleLetters(true));

        dragCanvas = document.getElementById("drag-line-canvas");
        dragCtx = dragCanvas.getContext("2d");

        const circleRect = circle.getBoundingClientRect();
        dragCanvas.width = circleRect.width;
        dragCanvas.height = circleRect.height;
        dragCanvas.style.top = "0";
        dragCanvas.style.left = "0";

        const centerX = 160;
        const centerY = 160;
        const radius = 110;
        const len = allLetters.length;

        allLetters.forEach((letter, i) => {
            const angle = (i / len) * 2 * Math.PI - Math.PI/2;
            const x = centerX + radius * Math.cos(angle) - 30;
            const y = centerY + radius * Math.sin(angle) - 30;

            const letterDiv = document.createElement("div");
            letterDiv.classList.add("letter");
            letterDiv.textContent = letter;
            letterDiv.style.left = `${x}px`;
            letterDiv.style.top = `${y}px`;
            letterDiv.setAttribute("data-letter", letter);
            letterDiv.setAttribute("role","button");
            letterDiv.setAttribute("tabindex","0");

            letterDiv.addEventListener("mousedown", handleDragStart);
            letterDiv.addEventListener("touchstart", handleDragStart, { passive: false });

            circle.appendChild(letterDiv);
        });
    }

    function getLetterCenter(letterElem) {
      const rect = letterElem.getBoundingClientRect();
      const circleRect = circle.getBoundingClientRect();
      return {
        x: (rect.left + rect.right) / 2 - circleRect.left,
        y: (rect.top + rect.bottom) / 2 - circleRect.top
      };
    }

    function handleDragStart(e) {
      e.preventDefault();
      const letterElem = e.target.closest(".letter");
      if (!letterElem) return;

      isDragging = true;
      selected = "";
      selectedLetterElements = [];
      clearActiveLetters();

      addLetterToSelection(letterElem);

      document.addEventListener("mousemove", handleDragMove);
      document.addEventListener("touchmove", handleDragMove, { passive: false });
      document.addEventListener("mouseup", handleDragEnd);
      document.addEventListener("touchend", handleDragEnd);
    }

    function addLetterToSelection(letterElem) {
      const letter = letterElem.getAttribute("data-letter");
      if (!selectedLetterElements.includes(letterElem)) {
        selected += letter;
        letterElem.classList.add("active");
        selectedLetterElements.push(letterElem);
        soundSelect.play().catch(() => {});
        updateSelectedWord();
        resultBox.textContent = "";
      }
    }

    function handleDragMove(e) {
      if (!isDragging) return;
      e.preventDefault();

      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;

      const circleRect = circle.getBoundingClientRect();
      const relativeX = clientX - circleRect.left;
      const relativeY = clientY - circleRect.top;

      dragCtx.clearRect(0, 0, dragCanvas.width, dragCanvas.height);

      for (let i = 0; i < selectedLetterElements.length - 1; i++) {
        const p1 = getLetterCenter(selectedLetterElements[i]);
        const p2 = getLetterCenter(selectedLetterElements[i + 1]);
        drawLine(p1.x, p1.y, p2.x, p2.y);
      }

      if (selectedLetterElements.length > 0) {
        const lastLetterCenter = getLetterCenter(selectedLetterElements[selectedLetterElements.length - 1]);
        drawLine(lastLetterCenter.x, lastLetterCenter.y, relativeX, relativeY);
      }

      const allLettersInCircle = circle.querySelectorAll(".letter");
      allLettersInCircle.forEach(letterElem => {
        if (!selectedLetterElements.includes(letterElem)) {
          const rect = letterElem.getBoundingClientRect();
          if (clientX > rect.left && clientX < rect.right &&
              clientY > rect.top && clientY < rect.bottom) {
            addLetterToSelection(letterElem);
          }
        }
      });
    }

    function handleDragEnd() {
      if (!isDragging) return;
      isDragging = false;
      dragCtx.clearRect(0, 0, dragCanvas.width, dragCanvas.height);
      if (selected.length > 0) {
        checkWord();
      } else {
        clearActiveLetters(false);
      }
      document.removeEventListener("mousemove", handleDragMove);
      document.removeEventListener("touchmove", handleDragMove);
      document.removeEventListener("mouseup", handleDragEnd);
      document.removeEventListener("touchend", handleDragEnd);
    }

    function drawLine(x1, y1, x2, y2) {
      dragCtx.beginPath();
      dragCtx.moveTo(x1, y1);
      dragCtx.lineTo(x2, y2);
      dragCtx.lineWidth = 5;
      dragCtx.strokeStyle = "#ffcc00";
      dragCtx.lineCap = "round";
      dragCtx.stroke();
    }

    function updateSelectedWord() {
      selectedWordDisplay.textContent = selected ? selected : "";
    }

    function checkWord() {
      const upperWord = selected.toUpperCase();
      if(!upperWord) {
          resultBox.textContent = "Please select letters first!";
          soundError.play().catch(() => {});
          clearActiveLetters();
          return;
      }

      if(levels[currentLevel].words.includes(upperWord) && !foundWords.has(upperWord)) {
        foundWords.add(upperWord);
        soundComplete.play().catch(() => {});
        updatePills();
        hintBox.textContent = "";
        resultBox.textContent = `Great! üëç You found: ${upperWord}`;
        btnNext.disabled = foundWords.size !== levels[currentLevel].words.length;
        clearActiveLetters(false);
        if(foundWords.size === levels[currentLevel].words.length) {
          awardGems(500);
          setTimeout(showReward, 500);
        }
      } else {
        resultBox.textContent = `‚ùå "${selected}" is incorrect or already found. Try again!`;
        soundError.play().catch(() => {});
        clearActiveLetters();
      }
    }

    function awardGems(amount) {
        let currentGems = parseInt(localStorage.getItem('cricketWordCityGems')) || 0;
        currentGems += amount;
        localStorage.setItem('cricketWordCityGems', currentGems);
        
        rewardMessage.textContent = `üéâ Congrats! You earned ${amount} gems! üéâ`;
        rewardMessage.style.display = "block";
        setTimeout(() => {
            rewardMessage.style.display = "none";
        }, 3000);
    }

    function clearActiveLetters(playSound = true) {
      const letters = circle.querySelectorAll(".letter.active");
      letters.forEach(l => l.classList.remove("active"));
      selected = "";
      selectedLetterElements = [];
      updateSelectedWord();
      if(playSound) {
          soundError.play().catch(() => {});
      }
    }

    function updatePills(){
      const pills = pillboxes.children;
      levels[currentLevel].words.forEach((w, i) => {
        if(foundWords.has(w)) {
          pills[i].textContent = w;
          pills[i].classList.add("completed");
        }
      });
    }

    function showReward(){
      previewImage.src = imageUrls[currentLevel];
      previewText.textContent = levelDescriptions[currentLevel];
      rewardModal.style.display = "block";
      localStorage.setItem("cricketWordCity_level_" + currentLevel, "completed");

      for(let i = 0; i < 5; i++) {
        setTimeout(launchFireworks, i * 300);
      }
      animateFireworks();
    }

    function closeRewardModal(){
      rewardModal.style.display = "none";
    }

    btnHint.addEventListener("click", () => {
      if (hintsUsed >= hints.length) {
        hintBox.textContent = "No more hints for this level. ü§î";
        soundError.play().catch(() => {});
        return;
      }
      hintBox.textContent = "Hint: " + hints[hintsUsed];
      hintsUsed++;
    });

    btnClear.addEventListener("click", clearActiveLetters);

    btnNext.addEventListener("click", () => {
      if(currentLevel + 1 < levels.length){
        currentLevel++;
        startLevel(currentLevel);
      } else {
        const totalGems = localStorage.getItem('cricketWordCityGems') || 0;
        alert(`üéâ You completed all levels and earned a total of ${totalGems} gems! Congrats! üéâ`);
        localStorage.removeItem('cricketWordCityGems');
        window.location.href = `index.html`;
      }
    });

    function resetGame(){
      foundWords.clear();
      selected = "";
      updateSelectedWord();
      hintBox.textContent = "";
      resultBox.textContent = "";
      clearActiveLetters(false);
      btnNext.disabled = true;
      if (dragCtx) {
        dragCtx.clearRect(0, 0, dragCanvas.width, dragCanvas.height);
      }
      const pills = pillboxes.querySelectorAll(".pill");
      pills.forEach(pill => pill.classList.remove("completed"));
    }

    let hints = [];
    function initializeGame() {
      showLevelSelect();
    }
  </script>
</body>
</html>
