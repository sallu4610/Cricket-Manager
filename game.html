<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cricket Word City - Powered Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* --- Splash Screen --- */
    #splash-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
    }
    #splash-screen img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* --- General Styles --- */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow-x: hidden;
      user-select: none;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 32px;
      text-align: center;
      margin: 10px 0 15px;
      text-shadow: 0 0 12px #ffcc00; /* Increased shadow for more pop */
    }

    /* --- Level Selection Screen --- */
    #level-select {
      display: none;
      width: 100%;
      max-width: 480px;
      padding: 10px;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-bottom: 15px;
      user-select: none;
      display: flex; /* Changed to flex for initial display */
    }
    .level-card {
      position: relative;
      width: 110px;
      height: 75px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px #ffcc00cc;
      cursor: pointer;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffcc00;
      font-weight: 700;
      font-size: 20px;
      text-shadow: 0 0 4px #ffcc00bb;
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smoother transition */
    }
    .level-card:hover:not(.locked) {
      transform: scale(1.08); /* More pronounced scale */
      box-shadow: 0 0 25px #ffaa00dd; /* Stronger glow on hover */
    }
    .level-card.locked {
      filter: blur(2px) grayscale(80%); /* Slightly less blur */
      cursor: default;
    }
    .level-card.locked::after {
      content: "üîí"; /* Emoji for locked */
      position: absolute;
      top: 5px; right: 5px;
      font-size: 26px;
      user-select: none;
    }
    .level-card img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      filter: brightness(0.5);
      border-radius: 12px;
    }
    .level-number {
      position: relative;
      z-index: 2;
    }

    /* --- Game Container --- */
    #game {
      display: none; /* Changed to none for initial display */
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 480px;
      padding: 20px;
      background-size: cover;
      background-position: center;
      min-height: 600px;
      position: relative;
      box-shadow: inset 0 0 80px #000a;
      border-radius: 14px;
      margin-bottom: 30px;
    }

    /* --- Pillboxes --- */
    #pillboxes {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 14px;
      perspective: 500px;
    }
    .pill {
      padding: 12px 20px;
      border-radius: 50px;
      background: linear-gradient(135deg, #ffcc00, #ffaa00);
      color: #000;
      font-size: 18px;
      font-weight: 900;
      min-width: 90px;
      text-align: center;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.3); /* Subtle inset shadow */
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* Added transition */
      user-select: none;
    }
    .pill.completed {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: #d4f2c5;
      box-shadow: 0 0 20px #28a745dd; /* Stronger glow on completion */
      transform: scale(1.1);
    }

    /* --- Selected Word Display --- */
    #selected-word {
      font-size: 28px; /* Slightly larger */
      margin: 12px 0 8px;
      letter-spacing: 6px;
      font-weight: 700;
      color: #ffcc00;
      text-shadow: 0 0 16px #ffcc00dd; /* Stronger glow */
      min-height: 32px;
      user-select: none;
      text-align: center;
      animation: pulse 1.5s infinite alternate; /* Pulsating effect */
    }

    /* Animation for selected-word */
    @keyframes pulse {
        from { text-shadow: 0 0 10px #ffcc00bb; }
        to { text-shadow: 0 0 25px #ffcc00ff; }
    }

    /* --- Letter Circle --- */
    #letter-circle {
      position: relative;
      width: 320px;
      height: 320px;
      margin: 0 auto 20px;
      border-radius: 50%;
      user-select: none;
      touch-action: none; /* Crucial for preventing default scroll on touch */
    }
    .letter {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #222;
      color: #fff;
      font-size: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s;
      z-index: 2; /* Letters above canvas */
      box-shadow: 0 0 8px #555; /* Slightly stronger default shadow */
      font-weight: 700;
    }
    .letter.active {
      background: #28a745;
      box-shadow: 0 0 20px #28a745dd, 0 0 40px #a6f199aa; /* More vibrant active state */
      transform: scale(1.05); /* Slight scale on active */
    }

    /* --- Shuffle Button --- */
    #shuffle-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px; /* Larger for better tap target */
      height: 70px;
      background: linear-gradient(45deg, #ffcc00, #ffaa00);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px; /* Larger emoji */
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
      z-index: 3; /* Above letters and canvas */
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    #shuffle-button:hover {
      transform: translate(-50%, -50%) scale(1.1);
      box-shadow: 0 0 25px rgba(255, 204, 0, 1);
    }

    /* --- Drag line canvas --- */
    #drag-line-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1; /* Below letters, above background */
      pointer-events: none; /* Allow events to pass through to letters below */
    }


    /* --- Hint and Result Boxes --- */
    #hint, #result {
      margin-top: 12px;
      padding: 10px 20px;
      background: rgba(0,0,0,0.75);
      border-radius: 8px;
      max-width: 90%;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      user-select: text;
      min-height: 32px;
      box-shadow: inset 0 0 8px #ffcc00aa;
    }

    /* --- Buttons --- */
    button {
      padding: 12px 28px;
      font-size: 18px;
      background: linear-gradient(135deg, #ffcc00, #ffaa00);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 18px 10px 0 10px;
      font-weight: 900;
      box-shadow: 0 0 14px #ffcc00aa;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 0 30px #ffcc00dd;
    }
    button:disabled {
      background: #666;
      cursor: default;
      box-shadow: none;
      color: #bbb;
      filter: grayscale(70%); /* Make disabled buttons clearly look disabled */
    }
    /* New button style for "Clear" and "Submit" (Submit button removed from HTML now) */
    #btn-clear {
        background: linear-gradient(135deg, #dc3545, #bd2130);
        box-shadow: 0 0 14px #dc3545aa;
    }
    #btn-clear:hover:not(:disabled) {
        box-shadow: 0 0 30px #dc3545dd;
    }


    /* --- Modal --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background-color: #111;
      margin: 10% auto;
      padding: 20px 30px;
      border: 3px solid #ffcc00;
      width: 85%;
      max-width: 420px;
      text-align: center;
      color: white;
      border-radius: 14px;
      box-shadow: 0 0 40px #ffcc00ee; /* More intense modal glow */
      position: relative;
    }
    .modal-content img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 20px #ffcc00bb;
      margin-bottom: 15px;
    }
    .close {
      color: #ffcc00;
      position: absolute;
      top: 12px;
      right: 18px;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
    }
    .close:hover {
      color: #ffaa00;
    }

    /* --- Fireworks Container --- */
    #fireworks-container {
      pointer-events: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 10000;
      overflow: visible;
    }

  </style>
</head>
<body>

  <div id="splash-screen">
    <img src="https://i.postimg.cc/NgDHSMY7/Picsart-25-07-24-20-15-56-995.png" alt="Splash" />
  </div>

  <div id="level-select" aria-label="Level selection screen" role="list"></div>

  <div id="game" role="main" aria-live="polite" aria-atomic="true" aria-label="Game screen">
    <h1>üèè Cricket Word City</h1>
    <div id="pillboxes" aria-label="Found words"></div>
    <div id="selected-word" aria-live="polite" aria-atomic="true"></div>

    <div id="letter-circle" aria-label="Letter selection circle" role="list">
        <canvas id="drag-line-canvas"></canvas>
        <div id="shuffle-button" aria-label="Shuffle letters">üîÄ</div>
    </div>

    <div id="hint" aria-live="polite" aria-atomic="true"></div>

    <button id="btn-hint" aria-label="Show hint">Hint ‚ú®</button>
    <button id="btn-clear" aria-label="Clear selected word">Clear üóëÔ∏è</button>
    <button id="btn-next" disabled aria-label="Next level">Next Level ‚ñ∂Ô∏è</button>
    <div id="result" aria-live="polite" aria-atomic="true"></div>

    <div id="rewardModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <div class="modal-content">
        <span class="close" onclick="closeRewardModal()" aria-label="Close modal">&times;</span>
        <img id="preview-image" src="" alt="Level background" />
        <p id="preview-text"></p>
      </div>
    </div>

  </div>

  <canvas id="fireworks-container"></canvas>

  <script>
    // === Your data from the code you sent ===
    const imageUrls = [
      "https://i.postimg.cc/BLVMxPHM/image.jpg",
      "https://i.postimg.cc/HJ3SkhxG/image.jpg",
      "https://i.postimg.cc/qhR1hxhN/image.jpg",
      "https://i.postimg.cc/JHHKK7Qm/image.jpg",
      "https://i.postimg.cc/WdvS6vqL/image.jpg",
      "https://i.postimg.cc/8s7yTwg3/image.jpg",
      "https://i.postimg.cc/PN0SJZtq/image.jpg",
      "https://i.postimg.cc/JGJPknn5/image.jpg",
      "https://i.postimg.cc/TKJ0t4ny/image.jpg",
      "https://i.postimg.cc/Ty29FJct/image.jpg"
    ];

    const levelDescriptions = [
      "üìÖ Jan 18, 2015: AB de Villiers smashed the fastest ODI century in just 31 balls against the West Indies.",
      "üìÖ Mar 21, 2022: Babar Azam scored a magnificent 196 runs against Australia in the Karachi Test.",
      "üìÖ Aug 22, 2019: Ben Stokes played a match-winning innings of 135 against Australia in the Ashes.",
      "üìÖ Mar 14, 1996: Michael Bevan hit a last-ball boundary to win vs West Indies in the World Cup.",
      "üìÖ Mar 3, 2016: Carlos Brathwaite hit 4 sixes in a row to win the 2016 T20 World Cup Final.",
      "üìÖ Jun 14, 2017: Bumrah bowled a lethal yorker to Maxwell in the Champions Trophy Final.",
      "üìÖ Apr 2, 2011: MS Dhoni's iconic six sealed the 2011 World Cup win for India.",
      "üìÖ Nov 2021: Rizwan went from ICU to semi-final hero in T20 WC 2021.",
      "üìÖ Mar 25, 1992: Imran Khan led Pakistan to their first World Cup victory.",
      "üìÖ Mar 2019: Kusal Perera scored an unforgettable 153* vs South Africa."
    ];

    const levels = [
      { words: ["SIX", "SPIN", "PACE"], hint: "Big boundary hit over fence, Ball turns on the pitch, Fast bowling speed" },
      { words: ["SLIP", "SEAM", "BAIL"], hint: "Fielder next to the wicketkeeper, Raised stitch on the ball, Small piece on top of stumps" },
      { words: ["BEAM", "JUMP", "OUT"], hint: "Bright light or laser (used for DRS), Quick move by a fielder, When a batsman is dismissed" },
      { words: ["DROP", "BAT", "YARD"], hint: "Fielder misses the catch, Equipment to hit the ball, Measurement of the cricket ground" },
      { words: ["FLY", "JERK", "ASH"], hint: "Ball hit high in the air, Sudden movement or twist, Historic Test cricket series" },
      { words: ["RUN", "HIT", "LEG"], hint: "Single point scored, Strike the ball with bat, Part of the body, also a fielding area" },
      { words: ["GAP", "PAD", "TIP"], hint: "Space between fielders, Protective gear for legs, Edge of the bat" },
      { words: ["WIDE", "DOT", "RUNS"], hint: "Ball outside batsman's reach, Ball with no runs scored, Total points scored" },
      { words: ["BALL", "FIELD", "CATCH"], hint: "Spherical object bowled, Area where game is played, Grabbing the ball in the air" },
      { words: ["BOWL", "PLAY", "TEAM"], hint: "Deliver the ball to batsman, Participate in the game, Group of players" }
    ];

// --- Variables ---
let currentLevel = 0;
let selected = ""; // Stores the current word formed by clicked/dragged letters
let foundWords = new Set();
let hintsUsed = 0;
let gemsEarned = 0; // New variable to track gems earned

// Dragging related variables
let isDragging = false;
let selectedLetterElements = []; // To keep track of actual DOM elements currently selected in a drag
let dragCanvas;
let dragCtx;


// DOM Elements (initial selection, these will be updated for dynamic elements)
const splashScreen = document.getElementById("splash-screen");
const levelSelect = document.getElementById("level-select");
const gameContainer = document.getElementById("game");
const pillboxes = document.getElementById("pillboxes");
const selectedWordDisplay = document.getElementById("selected-word");
const circle = document.getElementById("letter-circle");
const hintBox = document.getElementById("hint");
const resultBox = document.getElementById("result");
const btnHint = document.getElementById("btn-hint");
const btnClear = document.getElementById("btn-clear");
const btnNext = document.getElementById("btn-next");
let btnShuffle; // This will be assigned dynamically after re-rendering
const rewardModal = document.getElementById("rewardModal");
const previewImage = document.getElementById("preview-image");
const previewText = document.getElementById("preview-text");

// Sounds
const soundSelect = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
const soundComplete = new Audio("https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg");
const soundError = new Audio("https://actions.google.com/sounds/v1/foley/whoosh_foley.ogg");
const soundShuffle = new Audio("https://actions.google.com/sounds/v1/ui/swipe_to_select.ogg"); // Sound for shuffle

// Fireworks canvas setup
const fwCanvas = document.getElementById("fireworks-container");
const fwCtx = fwCanvas.getContext("2d");
fwCanvas.width = window.innerWidth;
fwCanvas.height = window.innerHeight;
window.addEventListener("resize", () => {
  fwCanvas.width = window.innerWidth;
  fwCanvas.height = window.innerHeight;
});


// --- Fireworks classes and functions ---
class Firework {
  constructor() {
    this.x = Math.random() * fwCanvas.width;
    this.y = fwCanvas.height;
    this.targetY = Math.random() * fwCanvas.height / 2;
    this.speed = 5 + Math.random() * 3;
    this.particles = [];
    this.exploded = false;
    this.hue = Math.random() * 360; // Base hue for firework trail
  }
  update() {
    if (!this.exploded) {
      this.y -= this.speed;
      // Draw a small trail behind the ascending firework
      fwCtx.beginPath();
      fwCtx.arc(this.x, this.y + 15, 2, 0, Math.PI * 2); // Slight offset for trail effect
      fwCtx.fillStyle = `hsl(${this.hue}, 100%, 70%, 0.5)`;
      fwCtx.fill();

      if (this.y <= this.targetY) {
        this.explode();
      }
    }
    this.particles.forEach(p => p.update());
    this.particles = this.particles.filter(p => !p.done);
  }
  explode() {
    this.exploded = true;
    const count = 30 + Math.floor(Math.random() * 20);
    for(let i=0; i<count; i++){
      this.particles.push(new Particle(this.x, this.y, this.hue)); // Pass hue to particles
    }
  }
  draw() {
    // Firework body is drawn by the trail in update(), particles draw themselves
    this.particles.forEach(p => p.draw());
  }
  isDone() {
    return this.exploded && this.particles.length === 0;
  }
}

class Particle {
  constructor(x, y, hue) {
    this.x = x;
    this.y = y;
    this.speedX = (Math.random() - 0.5) * 8; // Slightly faster initial spread
    this.speedY = (Math.random() - 0.5) * 8;
    this.alpha = 1;
    this.size = 3 + Math.random() * 2;
    this.gravity = 0.05;
    this.done = false;
    this.color = `hsl(${hue + (Math.random() * 60 - 30)}, 100%, 60%)`; // Vary color slightly
  }
  update() {
    this.speedY += this.gravity;
    this.x += this.speedX;
    this.y += this.speedY;
    this.alpha -= 0.02;
    if (this.alpha <= 0) {
      this.done = true;
    }
  }
  draw() {
    fwCtx.save();
    fwCtx.globalAlpha = this.alpha;
    fwCtx.fillStyle = this.color;
    fwCtx.beginPath();
    fwCtx.arc(this.x, this.y, this.size, 0, Math.PI*2);
    fwCtx.fill();
    fwCtx.restore();
  }
}

let fireworks = [];
function launchFireworks(){
  fireworks.push(new Firework());
}

function animateFireworks(){
  fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
  fireworks.forEach(fw => {
    fw.update();
    fw.draw();
  });
  fireworks = fireworks.filter(fw => !fw.isDone());
  if (fireworks.length > 0) {
    requestAnimationFrame(animateFireworks);
  }
}

// --- Splash Screen Timer ---
setTimeout(() => {
  splashScreen.style.display = "none";
  initializeGame();
}, 3000); // Reduced to 3 seconds for faster entry

// --- Save/Load progress helper ---
function getSavedProgress() {
  for (let i = levels.length - 1; i >= 0; i--) {
    if (localStorage.getItem("cricketWordCity_level_" + i) === "completed") {
      return i + 1; // next level to play
    }
  }
  return 0; // start from first if none completed
}

// --- Show Level Select ---
function showLevelSelect(){
  levelSelect.innerHTML = "";
  gameContainer.style.display = "none";
  levelSelect.style.display = "flex";

  const maxUnlockedLevel = getSavedProgress();

  for(let i=0; i<levels.length; i++){
    const lvl = document.createElement("div");
    lvl.classList.add("level-card");
    lvl.setAttribute("role","listitem");
    lvl.setAttribute("tabindex","0");

    const img = document.createElement("img");
    img.src = imageUrls[i];
    img.alt = `Background image for level ${i+1}`;
    lvl.appendChild(img);

    const num = document.createElement("div");
    num.classList.add("level-number");
    num.textContent = i+1;
    lvl.appendChild(num);

    // Unlock if i <= max unlocked level
    const unlocked = i <= maxUnlockedLevel;
    if (!unlocked) {
      lvl.classList.add("locked");
      lvl.setAttribute("aria-disabled","true");
      lvl.removeAttribute("tabindex");
    } else {
      lvl.addEventListener("click", () => {
        currentLevel = i;
        startLevel(i);
      });
      lvl.addEventListener("keypress", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          currentLevel = i;
          startLevel(i);
        }
      });
    }
    levelSelect.appendChild(lvl);
  }
}

// --- Start Level ---
function startLevel(levelIndex){
  levelSelect.style.display = "none";
  gameContainer.style.display = "flex";
  resetGame();

  currentLevel = levelIndex;
  foundWords.clear();
  hintsUsed = 0;
  hintBox.textContent = "";
  resultBox.textContent = "";
  btnNext.disabled = true;

  // Set background image
  gameContainer.style.backgroundImage = `url('${imageUrls[levelIndex]}')`;

  // Prepare words
  setupLevel(levels[levelIndex].words);

  // Display hints (3 max)
  hints = levels[currentLevel].hint.split(",").map(h => h.trim()); // Corrected variable name
  hints = hints.slice(0,3);

  // Display pills for words
  pillboxes.innerHTML = "";
  levels[levelIndex].words.forEach(word => {
    const pill = document.createElement("div");
    pill.classList.add("pill");
    pill.textContent = "_".repeat(word.length); // Placeholder based on word length
    pillboxes.appendChild(pill);
  });

  selected = "";
  updateSelectedWord();
}

// Helper to shuffle letters (Fisher-Yates)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // Swap elements
    }
}

// --- Setup level words and letter circle ---
let allLetters = [];
function setupLevel(words) {
  // Combine all words' letters uniquely
  let lettersSet = new Set();
  words.forEach(w => {
    w.split("").forEach(l => lettersSet.add(l));
  });
  allLetters = Array.from(lettersSet);

  // Ensure 5-6 letters total for circle, add random if less
  while(allLetters.length < 5) {
    const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const randomLetter = alpha.charAt(Math.floor(Math.random()*alpha.length));
    if(!lettersSet.has(randomLetter)) {
      lettersSet.add(randomLetter);
      allLetters.push(randomLetter);
    }
  }
  // Keep all letters if more than 6 to avoid missing letters

  shuffleLetters(false); // Shuffle letters when a new level starts, no sound on initial load
}

// --- Shuffle Letters Function ---
function shuffleLetters(playSound = true) {
    clearActiveLetters(false); // Clear current selection and active states, no sound
    if (playSound) {
        soundShuffle.play().catch(() => {});
    }

    shuffleArray(allLetters); // Shuffle the array of letters

    // Re-render letters in the circle
    circle.innerHTML = "";
    const dragLineCanvas = document.createElement("canvas");
    dragLineCanvas.id = "drag-line-canvas";
    circle.appendChild(dragLineCanvas);

    // Re-append the shuffle button
    const shuffleButton = document.createElement("div");
    shuffleButton.id = "shuffle-button";
    shuffleButton.innerHTML = "üîÄ";
    circle.appendChild(shuffleButton);

    // CRITICAL FIX: Re-assign btnShuffle and re-attach its event listener
    btnShuffle = document.getElementById("shuffle-button");
    btnShuffle.addEventListener("click", () => shuffleLetters(true));

    // Re-assign dragCanvas and dragCtx as the canvas was re-added
    dragCanvas = document.getElementById("drag-line-canvas");
    dragCtx = dragCanvas.getContext("2d");

    // Re-adjust canvas size
    const circleRect = circle.getBoundingClientRect();
    dragCanvas.width = circleRect.width;
    dragCanvas.height = circleRect.height;
    dragCanvas.style.top = "0";
    dragCanvas.style.left = "0";

    const centerX = 160;
    const centerY = 160;
    const radius = 110;
    const len = allLetters.length;

    allLetters.forEach((letter, i) => {
        const angle = (i / len) * 2 * Math.PI - Math.PI/2;
        const x = centerX + radius * Math.cos(angle) - 30;
        const y = centerY + radius * Math.sin(angle) - 30;

        const letterDiv = document.createElement("div");
        letterDiv.classList.add("letter");
        letterDiv.textContent = letter;
        letterDiv.style.left = `${x}px`;
        letterDiv.style.top = `${y}px`;
        letterDiv.setAttribute("data-letter", letter);
        letterDiv.setAttribute("role","button");
        letterDiv.setAttribute("tabindex","0");

        letterDiv.addEventListener("mousedown", handleDragStart);
        letterDiv.addEventListener("touchstart", handleDragStart, { passive: false });

        circle.appendChild(letterDiv);
    });
}


// Helper to get center of a letter element relative to its parent (#letter-circle)
function getLetterCenter(letterElem) {
    const rect = letterElem.getBoundingClientRect();
    const circleRect = circle.getBoundingClientRect();
    return {
        x: (rect.left + rect.right) / 2 - circleRect.left,
        y: (rect.top + rect.bottom) / 2 - circleRect.top
    };
}

function handleDragStart(e) {
    e.preventDefault(); // Prevent default browser actions (like scrolling on touch)
    const letterElem = e.target.closest(".letter");
    if (!letterElem) return;

    isDragging = true;
    selected = "";
    selectedLetterElements = []; // Reset for new drag
    clearActiveLetters(); // Ensure all visual active states are cleared

    addLetterToSelection(letterElem);

    // Add global event listeners for dragging and ending
    document.addEventListener("mousemove", handleDragMove);
    document.addEventListener("touchmove", handleDragMove, { passive: false });
    document.addEventListener("mouseup", handleDragEnd);
    document.addEventListener("touchend", handleDragEnd);
}

function addLetterToSelection(letterElem) {
    const letter = letterElem.getAttribute("data-letter");
    if (!selectedLetterElements.includes(letterElem)) { // Ensure letter is not already in the current drag sequence
        selected += letter;
        letterElem.classList.add("active");
        selectedLetterElements.push(letterElem);
        soundSelect.play().catch(() => {});
        updateSelectedWord();
        resultBox.textContent = ""; // Clear previous result when new letter is added
    }
}

function handleDragMove(e) {
    if (!isDragging) return;
    e.preventDefault(); // Prevent scrolling on touch devices during drag

    // Get current pointer position relative to the canvas/circle
    const clientX = e.clientX || e.touches[0].clientX;
    const clientY = e.clientY || e.touches[0].clientY;

    const circleRect = circle.getBoundingClientRect();
    const relativeX = clientX - circleRect.left;
    const relativeY = clientY - circleRect.top;

    dragCtx.clearRect(0, 0, dragCanvas.width, dragCanvas.height);

    // Draw lines between currently selected letters
    for (let i = 0; i < selectedLetterElements.length - 1; i++) {
        const p1 = getLetterCenter(selectedLetterElements[i]);
        const p2 = getLetterCenter(selectedLetterElements[i + 1]);
        drawLine(p1.x, p1.y, p2.x, p2.y);
    }

    // Draw line from last selected letter to current pointer
    if (selectedLetterElements.length > 0) {
        const lastLetterCenter = getLetterCenter(selectedLetterElements[selectedLetterElements.length - 1]);
        drawLine(lastLetterCenter.x, lastLetterCenter.y, relativeX, relativeY);
    }

    // Check if pointer is over another letter
    const allLettersInCircle = circle.querySelectorAll(".letter");
    allLettersInCircle.forEach(letterElem => {
        if (!selectedLetterElements.includes(letterElem)) { // Only consider non-active letters in current sequence
            const rect = letterElem.getBoundingClientRect();
            // Check if mouse/touch is within this letter's bounds
            if (clientX > rect.left && clientX < rect.right &&
                clientY > rect.top && clientY < rect.bottom) {
                addLetterToSelection(letterElem); // Add this letter to selection
            }
        }
    });
}

function handleDragEnd() {
    if (!isDragging) return;
    isDragging = false;

    dragCtx.clearRect(0, 0, dragCanvas.width, dragCanvas.height); // Clear all lines

    // Only check word if letters were actually selected during the drag
    if (selected.length > 0) {
        checkWord(); // Check the formed word
    } else {
        clearActiveLetters(false); // Clear immediately if nothing was selected, no sound
    }


    // Remove global listeners
    document.removeEventListener("mousemove", handleDragMove);
    document.removeEventListener("touchmove", handleDragMove);
    document.removeEventListener("mouseup", handleDragEnd);
    document.removeEventListener("touchend", handleDragEnd);
}

function drawLine(x1, y1, x2, y2) {
    dragCtx.beginPath();
    dragCtx.moveTo(x1, y1);
    dragCtx.lineTo(x2, y2);
    dragCtx.lineWidth = 5;
    dragCtx.strokeStyle = "#ffcc00"; // Gold color for the line
    dragCtx.lineCap = "round"; // Make line ends rounded
    dragCtx.stroke();
}


function updateSelectedWord() {
  selectedWordDisplay.textContent = selected ? selected : "";
}

// --- Check word function (now called automatically on drag end) ---
function checkWord() {
  const upperWord = selected.toUpperCase();
  if(!upperWord) {
      resultBox.textContent = "Please select letters first!";
      soundError.play().catch(() => {});
      clearActiveLetters(); // Ensure letters are cleared visually
      return;
  }

  if(levels[currentLevel].words.includes(upperWord) && !foundWords.has(upperWord)) {
    foundWords.add(upperWord);
    soundComplete.play().catch(() => {});
    updatePills();
    hintBox.textContent = ""; // Clear hint when word is found
    resultBox.textContent = `Great! üëç You found: ${upperWord}`;
    btnNext.disabled = foundWords.size !== levels[currentLevel].words.length;

    // Clear selected word after successful guess
    clearActiveLetters(false); // No sound on successful clear

    if(foundWords.size === levels[currentLevel].words.length) {
      // Award gems for completing the level
      gemsEarned += 500; 
      setTimeout(showReward, 500); // Small delay before showing reward
    }
  } else {
    resultBox.textContent = `‚ùå "${selected}" is incorrect or already found. Try again!`;
    soundError.play().catch(() => {});
    clearActiveLetters(); // Clear selection on incorrect guess
  }
}

function clearActiveLetters(playSound = true) { // Optional parameter to control sound
  const letters = circle.querySelectorAll(".letter.active");
  letters.forEach(l => l.classList.remove("active"));
  selected = "";
  selectedLetterElements = []; // Clear the array of selected elements too
  updateSelectedWord();
  // Don't clear resultBox here, let checkWord or other events manage it
  if(playSound) {
      soundError.play().catch(() => {}); // Play clear sound only if specified
  }
}


// --- Update pillboxes ---
function updatePills(){
  const pills = pillboxes.children;
  levels[currentLevel].words.forEach((w, i) => {
    if(foundWords.has(w)) {
      pills[i].textContent = w;
      // Add a class that triggers the animation
      pills[i].classList.add("completed");
    }
  });
}

// --- Show reward modal ---
function showReward(){
  previewImage.src = imageUrls[currentLevel];
  previewText.textContent = levelDescriptions[currentLevel];
  rewardModal.style.display = "block";

  // Launch fireworks multiple times for a richer display
  for(let i = 0; i < 5; i++) {
    setTimeout(launchFireworks, i * 300); // Launch fireworks with a slight delay
  }
  animateFireworks();
}

function closeRewardModal(){
  rewardModal.style.display = "none";
}

// --- Buttons ---
btnHint.addEventListener("click", () => {
  if (hintsUsed >= hints.length) { // Check against available hints from data
    hintBox.textContent = "No more hints for this level. ü§î";
    soundError.play().catch(() => {});
    return;
  }
  hintBox.textContent = "Hint: " + hints[hintsUsed];
  hintsUsed++;
});

// Clear button is still useful
btnClear.addEventListener("click", clearActiveLetters);

// btnShuffle listener is now inside shuffleLetters()

btnNext.addEventListener("click", () => {
  localStorage.setItem("cricketWordCity_level_" + currentLevel, "completed");
  if(currentLevel + 1 < levels.length){
    currentLevel++;
    startLevel(currentLevel);
  } else {
    // Redirect to main page with gems earned in the URL
    window.location.href = `index.html?gems=${gemsEarned}`;
  }
});

// --- Reset game ---
function resetGame(){
  foundWords.clear();
  selected = "";
  updateSelectedWord();
  hintBox.textContent = "";
  resultBox.textContent = "";
  clearActiveLetters(false); // Ensure letters are cleared visually, no sound on reset
  btnNext.disabled = true;
  // Clear the drag canvas in case any lines were left
  if (dragCtx) {
    dragCtx.clearRect(0, 0, dragCanvas.width, dragCanvas.height);
  }
  // Remove .completed class from all pills
  const pills = pillboxes.querySelectorAll(".pill");
  pills.forEach(pill => pill.classList.remove("completed"));
}

// --- Initialize ---
let hints = [];
function initializeGame() {
  showLevelSelect();  // always show level select on load
}

  </script>

</body>
</html>
